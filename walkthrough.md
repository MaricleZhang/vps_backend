# VPS åå°ç®¡ç†ç³»ç»Ÿå®ç°å®ŒæˆæŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ VPS åå°ç®¡ç†ç³»ç»Ÿï¼Œä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œæä¾›ç”¨æˆ·ç®¡ç†ã€è®¢é˜…ç®¡ç†ã€æµé‡æ§åˆ¶å’ŒèŠ‚ç‚¹ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## å·²å®ç°åŠŸèƒ½

### âœ… æ ¸å¿ƒåŠŸèƒ½

#### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- **ç”¨æˆ·æ³¨å†Œ** - é‚®ç®±+å¯†ç æ³¨å†Œ,è‡ªåŠ¨å¯†ç åŠ å¯†
- **ç”¨æˆ·ç™»å½•** - JWT Token è®¤è¯
- **å¯†ç é‡ç½®** - éªŒè¯ç å‘é€å’Œå¯†ç é‡ç½®æµç¨‹
- **Token éªŒè¯** - ä¸­é—´ä»¶ä¿æŠ¤å—ä¿æŠ¤çš„è·¯ç”±

#### 2. ç”¨æˆ·ç®¡ç†
- **ç”¨æˆ·ä¿¡æ¯** - è·å–å’Œæ›´æ–°ç”¨æˆ·èµ„æ–™
- **å¯†ç ä¿®æ”¹** - éªŒè¯æ—§å¯†ç åä¿®æ”¹
- **ä½™é¢ç®¡ç†** - æŸ¥è¯¢ã€å……å€¼ã€æ‰£è´¹(å¸¦äº‹åŠ¡ä¿æŠ¤)
- **æµé‡ç»Ÿè®¡** - å®æ—¶æŸ¥è¯¢ç”¨æˆ·æµé‡ä½¿ç”¨æƒ…å†µ

#### 3. è®¢é˜…ç³»ç»Ÿ
- **å¥—é¤ç®¡ç†** - å¤šçº§è®¢é˜…å¥—é¤(åŸºç¡€/æ ‡å‡†/é«˜çº§/æ——èˆ°)
- **è´­ä¹°è®¢é˜…** - ä½™é¢æ‰£è´¹ + åˆ›å»ºè®¢é˜… + åˆ†é…èŠ‚ç‚¹æƒé™(åŸå­æ“ä½œ)
- **ç»­è´¹è®¢é˜…** - å»¶é•¿è®¢é˜…æœ‰æ•ˆæœŸ
- **å–æ¶ˆè®¢é˜…** - è®¢é˜…çŠ¶æ€ç®¡ç†
- **è®¢é˜…é“¾æ¥** - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€è®¢é˜…URL

#### 4. æµé‡æ§åˆ¶
- **æµé‡è®°å½•** - è®°å½•æ¯æ¬¡ä½¿ç”¨çš„ä¸Šä¼ /ä¸‹è½½æµé‡
- **é…é¢é™åˆ¶** - è‡ªåŠ¨æ£€æŸ¥æ˜¯å¦è¶…å‡ºæµé‡é™é¢
- **ä½¿ç”¨ç»Ÿè®¡** - å®æ—¶ç»Ÿè®¡ç”¨æˆ·æ€»æµé‡ä½¿ç”¨
- **ç™¾åˆ†æ¯”è®¡ç®—** - æµé‡ä½¿ç”¨ç™¾åˆ†æ¯”æ˜¾ç¤º

#### 5. èŠ‚ç‚¹ç®¡ç†
- **èŠ‚ç‚¹åˆ—è¡¨** - æ”¯æŒæŒ‰åœ°åŒºå’Œåè®®ç­›é€‰
- **èŠ‚ç‚¹è¯¦æƒ…** - æŸ¥çœ‹èŠ‚ç‚¹å®Œæ•´ä¿¡æ¯
- **å»¶è¿Ÿæµ‹è¯•** - æµ‹è¯•èŠ‚ç‚¹è¿æ¥å»¶è¿Ÿ
- **è®¿é—®æ§åˆ¶** - åŸºäºè®¢é˜…çš„èŠ‚ç‚¹è®¿é—®æƒé™ç®¡ç†

---

## é¡¹ç›®ç»“æ„

```
vps_backend/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ server/main.go          # ä¸»ç¨‹åºå…¥å£
â”‚   â””â”€â”€ seed/main.go            # æ•°æ®åº“ç§å­æ•°æ®
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ handler/            # HTTP å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.go         # âœ… è®¤è¯å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ user.go         # âœ… ç”¨æˆ·å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ subscription.go # âœ… è®¢é˜…å¤„ç†
â”‚   â”‚   â”‚   â””â”€â”€ node.go         # âœ… èŠ‚ç‚¹å¤„ç†
â”‚   â”‚   â””â”€â”€ router/
â”‚   â”‚       â””â”€â”€ router.go       # âœ… è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ service/                # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ auth_service.go     # âœ… è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ user_service.go     # âœ… ç”¨æˆ·æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ subscription_service.go # âœ… è®¢é˜…æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ node_service.go     # âœ… èŠ‚ç‚¹æœåŠ¡
â”‚   â”‚   â””â”€â”€ service_test.go     # âœ… å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ model/                  # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.go             # âœ… ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ subscription.go     # âœ… è®¢é˜…æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ node.go             # âœ… èŠ‚ç‚¹æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ traffic.go          # âœ… æµé‡æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ order.go            # âœ… è®¢å•æ¨¡å‹
â”‚   â”‚   â””â”€â”€ other.go            # âœ… å…¶ä»–æ¨¡å‹
â”‚   â”œâ”€â”€ middleware/             # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.go             # âœ… JWT è®¤è¯
â”‚   â”‚   â”œâ”€â”€ cors.go             # âœ… è·¨åŸŸå¤„ç†
â”‚   â”‚   â””â”€â”€ logger.go           # âœ… è¯·æ±‚æ—¥å¿—
â”‚   â””â”€â”€ util/                   # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ jwt.go              # âœ… JWT å·¥å…·
â”‚       â”œâ”€â”€ password.go         # âœ… å¯†ç åŠ å¯†
â”‚       â””â”€â”€ response.go         # âœ… ç»Ÿä¸€å“åº”
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ db/postgres.go          # âœ… æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ cache/redis.go          # âœ… Redis ç¼“å­˜
â”œâ”€â”€ config/config.yaml          # âœ… é…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml          # âœ… Docker é…ç½®
â”œâ”€â”€ Makefile                    # âœ… æ„å»ºè„šæœ¬
â”œâ”€â”€ start.sh                    # âœ… å¿«é€Ÿå¯åŠ¨è„šæœ¬
â””â”€â”€ README.md                   # âœ… é¡¹ç›®æ–‡æ¡£
```

---

## æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### users - ç”¨æˆ·è¡¨
```sql
id, email, username, password_hash, avatar, balance, 
status, created_at, updated_at, last_login_at
```

#### subscription_plans - è®¢é˜…å¥—é¤è¡¨
```sql
id, name, description, price, traffic_limit, duration_days,
features (JSONB), is_active, sort_order
```

#### subscriptions - ç”¨æˆ·è®¢é˜…è¡¨
```sql
id, user_id, plan_id, name, type, status, traffic_limit,
traffic_used, price, duration_days, subscribe_url,
started_at, expired_at
```

#### nodes - VPS èŠ‚ç‚¹è¡¨
```sql
id, name, location, protocol, server_address, server_port,
status, latency, load_percentage, bandwidth, 
max_connections, current_connections, config (JSONB)
```

#### user_node_access - ç”¨æˆ·èŠ‚ç‚¹è®¿é—®æƒé™è¡¨
```sql
id, user_id, node_id, subscription_id, granted_at, expired_at
UNIQUE(user_id, node_id)
```

#### traffic_logs - æµé‡æ—¥å¿—è¡¨
```sql
id, user_id, subscription_id, node_id,
upload_bytes, download_bytes, total_bytes, recorded_at
```

#### orders - è®¢å•è¡¨
```sql
id, user_id, order_no, type, plan_id, amount,
payment_method, status, paid_at
``` 

---

## API ç«¯ç‚¹æ¸…å•

### è®¤è¯æ¥å£ (æ— éœ€Token)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| POST | `/api/auth/login` | ç”¨æˆ·ç™»å½• | âœ… |
| POST | `/api/auth/register` | ç”¨æˆ·æ³¨å†Œ | âœ… |
| POST | `/api/auth/send-reset-code` | å‘é€é‡ç½®éªŒè¯ç  | âœ… |
| POST | `/api/auth/reset-password` | é‡ç½®å¯†ç  | âœ… |

### ç”¨æˆ·æ¥å£ (éœ€è¦Token)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| GET | `/api/user/info` | è·å–ç”¨æˆ·ä¿¡æ¯ | âœ… |
| PUT | `/api/user/info` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | âœ… |
| POST | `/api/user/change-password` | ä¿®æ”¹å¯†ç  | âœ… |

### è´¦æˆ·æ¥å£ (éœ€è¦Token)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| GET | `/api/account/balance` | è·å–ä½™é¢ | âœ… |
| GET | `/api/account/traffic` | è·å–æµé‡ä½¿ç”¨ | âœ… |
| GET | `/api/account/stats` | è·å–è´¦æˆ·ç»Ÿè®¡ | âœ… |
| POST | `/api/account/recharge` | è´¦æˆ·å……å€¼ | âœ… |

### è®¢é˜…æ¥å£ (éœ€è¦Token)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| GET | `/api/subscriptions` | è·å–è®¢é˜…åˆ—è¡¨ | âœ… |
| GET | `/api/subscriptions/plans` | è·å–å¯ç”¨å¥—é¤ | âœ… |
| POST | `/api/subscriptions/purchase` | è´­ä¹°è®¢é˜… | âœ… |
| POST | `/api/subscriptions/renew` | ç»­è´¹è®¢é˜… | âœ… |
| DELETE | `/api/subscriptions/:id` | å–æ¶ˆè®¢é˜… | âœ… |

### èŠ‚ç‚¹æ¥å£ (éœ€è¦Token)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| GET | `/api/nodes` | è·å–èŠ‚ç‚¹åˆ—è¡¨ | âœ… |
| GET | `/api/nodes/:id` | è·å–èŠ‚ç‚¹è¯¦æƒ… | âœ… |
| POST | `/api/nodes/:id/test` | æµ‹è¯•èŠ‚ç‚¹å»¶è¿Ÿ | âœ… |

---

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æ•°æ®åº“æœåŠ¡

```bash
# å¯åŠ¨ PostgreSQL å’Œ Redis
docker-compose up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
# è¿è¡ŒæœåŠ¡å™¨(ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„)
go run cmd/server/main.go
```

### 3. æ·»åŠ æµ‹è¯•æ•°æ®

```bash
# è¿è¡Œç§å­æ•°æ®è„šæœ¬
go run cmd/seed/main.go
```

> [!NOTE]
> ç§å­æ•°æ®åŒ…å«:
> - 4ä¸ªæµ‹è¯•ç”¨æˆ·(å«ç®¡ç†å‘˜)
> - 4ä¸ªè®¢é˜…å¥—é¤
> - 8ä¸ªä¸åŒåœ°åŒºçš„VPSèŠ‚ç‚¹
> - 3æ¡ç³»ç»Ÿå…¬å‘Š

### 4. ä½¿ç”¨å¿«é€Ÿå¯åŠ¨è„šæœ¬

```bash
# ä¸€é”®å¯åŠ¨(æ¨è)
chmod +x start.sh
./start.sh
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è´¦æˆ·

| é‚®ç®± | å¯†ç  | ä½™é¢ | è¯´æ˜ |
|------|------|------|------|
| `admin@example.com` | `admin123456` | Â¥10,000 | ç®¡ç†å‘˜ |
| `demo@example.com` | `123456` | Â¥1,000 | æ¼”ç¤ºç”¨æˆ· |
| `user1@example.com` | `123456` | Â¥500 | æ™®é€šç”¨æˆ· |
| `user2@example.com` | `123456` | Â¥200 | æ™®é€šç”¨æˆ· |

### API æµ‹è¯•ç¤ºä¾‹

#### 1. ç”¨æˆ·ç™»å½•

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "demo@example.com",
    "password": "123456"
  }'
```

**å“åº”:**
```json
{
  "code": 0,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 2,
      "email": "demo@example.com",
      "username": "demo"
    }
  }
}
```

#### 2. è·å–ç”¨æˆ·ä¿¡æ¯

```bash
export TOKEN="your_jwt_token_here"

curl -X GET http://localhost:8080/api/user/info \
  -H "Authorization: Bearer $TOKEN"
```

#### 3. æŸ¥çœ‹å¯ç”¨å¥—é¤

```bash
curl -X GET http://localhost:8080/api/subscriptions/plans \
  -H "Authorization: Bearer $TOKEN"
```

**å“åº”:**
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "åŸºç¡€å¥—é¤",
      "description": "é€‚åˆè½»åº¦ä½¿ç”¨è€…",
      "price": 29.90,
      "traffic": 107374182400,
      "duration": 30,
      "features": ["100GBæµé‡", "5ä¸ªè®¾å¤‡åŒæ—¶åœ¨çº¿", "æ ‡å‡†é€Ÿåº¦"]
    }
  ]
}
```

#### 4. è´­ä¹°è®¢é˜…

```bash
curl -X POST http://localhost:8080/api/subscriptions/purchase \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "planId": 1,
    "paymentMethod": "balance"
  }'
```

#### 5. æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨

```bash
# è·å–æ‰€æœ‰æ—¥æœ¬èŠ‚ç‚¹
curl -X GET "http://localhost:8080/api/nodes?location=JP" \
  -H "Authorization: Bearer $TOKEN"
```

#### 6. æŸ¥çœ‹æµé‡ä½¿ç”¨

```bash
curl -X GET http://localhost:8080/api/account/traffic \
  -H "Authorization: Bearer $TOKEN"
```

---

## å•å…ƒæµ‹è¯•

è¿è¡Œæµ‹è¯•:

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œç‰¹å®šåŒ…çš„æµ‹è¯•
go test ./internal/service/

# å¸¦è¦†ç›–ç‡æŠ¥å‘Š
go test -cover ./...
```

æµ‹è¯•è¦†ç›–:
- âœ… ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- âœ… ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- âœ… ä½™é¢å¢åŠ å’Œæ‰£é™¤
- âœ… ä½™é¢ä¸è¶³æ£€æŸ¥

---

## æ ¸å¿ƒç‰¹æ€§å®ç°ç»†èŠ‚

### 1. æµé‡æ§åˆ¶æœºåˆ¶

**æµé‡è®°å½•:**
```go
// è®°å½•ç”¨æˆ·æµé‡ä½¿ç”¨
service.RecordTraffic(userID, nodeID, uploadBytes, downloadBytes)
```

**é…é¢æ£€æŸ¥:**
- è´­ä¹°è®¢é˜…æ—¶è®¾ç½® `traffic_limit`
- æ¯æ¬¡ä½¿ç”¨ç´¯åŠ åˆ° `traffic_used`
- è¶…é™æ—¶æ‹’ç»æœåŠ¡

**æ•°æ®æµ:**
```
ç”¨æˆ·è¯·æ±‚ â†’ æ£€æŸ¥ traffic_used < traffic_limit 
         â†’ å…è®¸ä½¿ç”¨ â†’ è®°å½•æµé‡ â†’ æ›´æ–° traffic_used
```

### 2. è®¢é˜…è´­ä¹°æµç¨‹

ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿åŸå­æ€§:

1. é”å®šç”¨æˆ·è®°å½•
2. æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
3. æ‰£é™¤ä½™é¢
4. åˆ›å»ºè®¢é˜…è®°å½•
5. åˆ›å»ºè®¢å•è®°å½•
6. åˆ†é…æ‰€æœ‰èŠ‚ç‚¹è®¿é—®æƒé™
7. æäº¤äº‹åŠ¡

### 3. å®‰å…¨æªæ–½

- âœ… **å¯†ç åŠ å¯†** - bcrypt (cost=14)
- âœ… **JWTè®¤è¯** - HS256ç­¾å,24å°æ—¶æœ‰æ•ˆæœŸ
- âœ… **TokenéªŒè¯** - ä¸­é—´ä»¶è‡ªåŠ¨éªŒè¯
- âœ… **CORSä¿æŠ¤** - é™åˆ¶å…è®¸çš„æ¥æº
- âœ… **è¯·æ±‚æ—¥å¿—** - è®°å½•æ‰€æœ‰APIè¯·æ±‚

### 4. æ•°æ®åº“ä¼˜åŒ–

- âœ… **ç´¢å¼•ä¼˜åŒ–** - email, status, user_id, expired_at
- âœ… **è¿æ¥æ± ** - max_open: 100, max_idle: 10
- âœ… **äº‹åŠ¡ä¿æŠ¤** - å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡
- âœ… **JSONBæ”¯æŒ** - features, configå­˜å‚¨ä¸ºJSON

---

## ç¯å¢ƒè¦æ±‚

- Go 1.21+
- PostgreSQL 15+
- Redis 7+ (å¯é€‰)
- Docker & Docker Compose (æ¨è)

---

## ä¸‹ä¸€æ­¥å»ºè®®

### å¯é€‰å¢å¼ºåŠŸèƒ½

1. **æµé‡é‡ç½®å®šæ—¶ä»»åŠ¡**
   - ä½¿ç”¨ cron æ¯æœˆé‡ç½®æµé‡
   - å®ç°åˆ°æœŸè®¢é˜…è‡ªåŠ¨ç»­è´¹æé†’

2. **ç®¡ç†åå° API**
   - ç”¨æˆ·ç®¡ç† CRUD
   - èŠ‚ç‚¹ç®¡ç† CRUD  
   - è®¢å•ç®¡ç†å’Œç»Ÿè®¡

3. **æ”¯ä»˜é›†æˆ**
   - æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
   - æ”¯ä»˜å›è°ƒå¤„ç†
   - æ”¯ä»˜è®¢å•çŠ¶æ€æ›´æ–°

4. **é€šçŸ¥ç³»ç»Ÿ**
   - é‚®ä»¶é€šçŸ¥(æ³¨å†Œ,è´­ä¹°,åˆ°æœŸ)
   - WebSocketå®æ—¶æ¨é€
   - ç«™å†…æ¶ˆæ¯

5. **ç›‘æ§å’Œåˆ†æ**
   - Prometheus metrics
   - æµé‡è¶‹åŠ¿å›¾è¡¨
   - èŠ‚ç‚¹æ€§èƒ½ç›‘æ§

---

## æ€»ç»“

### âœ… å·²å®Œæˆ

- å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæˆæƒç³»ç»Ÿ
- è®¢é˜…å¥—é¤ç®¡ç†å’Œè´­ä¹°æµç¨‹
- æµé‡ç›‘æ§å’Œé…é¢æ§åˆ¶
- å¤šåœ°åŒº VPS èŠ‚ç‚¹ç®¡ç†
- æ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- Docker éƒ¨ç½²é…ç½®
- å•å…ƒæµ‹è¯•
- å®Œæ•´æ–‡æ¡£

### ğŸ“Š ä»£ç ç»Ÿè®¡

- **Go æ–‡ä»¶**: 20+
- **ä»£ç è¡Œæ•°**: ~2000+
- **API ç«¯ç‚¹**: 18
- **æ•°æ®è¡¨**: 9
- **æµ‹è¯•ç”¨ä¾‹**: 6+

### ğŸ¯ è´¨é‡ä¿è¯

- âœ… ç±»å‹å®‰å…¨ (Go å¼ºç±»å‹)
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… äº‹åŠ¡ä¿æŠ¤å…³é”®æ“ä½œ
- âœ… SQL æ³¨å…¥é˜²æŠ¤ (GORM)
- âœ… ç»Ÿä¸€å“åº”æ ¼å¼
- âœ… æ—¥å¿—è®°å½•

---

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦æ‰©å±•åŠŸèƒ½,è¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**ç¥ä½¿ç”¨æ„‰å¿«! ğŸš€**
